                  PRESERVE8

                  AREA    PSA, CODE, READONLY
                  ARM

;----------------------------------------------------------------------
;   4 | UINT32 PSA_U32(UINT32 *pstart, UINT32 plength, UINT32 pseed)
;----------------------------------------------------------------------

;*****************************************************************************
;* FUNCTION NAME: _PSA                                                       *
;*****************************************************************************
PSA_U32

                  EXPORT  PSA_U32

        MRS       R12, CPSR             ; save int flags
        ORR       R3,R12,#0x00000C0     ; set int disable bits
        MSR       CPSR_c,R3             ; disable ints


;----------------------------------------------------------------------
;   5 | { int k;
;   6 | volatile UINT32 *daddr;
;   8 | daddr=pstart;
;   9 | *(UINT32 *)0xffffff50=0;
;----------------------------------------------------------------------
        MVN       R3, #191
        STR       R0, [R3, #16]         ; R1 contains start address which
                                        ;   must have lsb = 0;
;----------------------------------------------------------------------
;  10 | *(UINT32 *)0xffffff40=pseed;         /* initialize register to seed */
;----------------------------------------------------------------------
        STR       R2, [R3, #0]          ; |10|
;----------------------------------------------------------------------
;  11 | for (k=0;k<plength;k++)              /* Step through each flash locatio
;  12 | *daddr++;                              /* Read flash data */
;----------------------------------------------------------------------
L1
        LDR       R2, [R0], #4          ; |12|
        SUBS      R1, R1, #1            ; |12|
        BNE       L1                    ; |12|
;----------------------------------------------------------------------
;  13 | *(UINT32 *)0xffffff50=1;                     /* disable PSA */
;----------------------------------------------------------------------
        MOV       R2, #1                ; |13|
        STR       R2, [R3, #16]         ; |13|

     ;  MSR       CPSR,V9               ; restore ints

        MSR       CPSR_c,R12            ; restore ints
;----------------------------------------------------------------------
;  14 | return *(UINT32 *)0xffffff40;
;----------------------------------------------------------------------
        LDR       R0, [R3, #0]          ; |14|
        BX        LR

        END
